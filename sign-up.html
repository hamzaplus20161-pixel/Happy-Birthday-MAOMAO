<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Souq Alahmadiya - Auth</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: "Cairo", sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .page {
            width: 95%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 12px rgba(0,0,0,0.1);
            display: none;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6f3c;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background: #ff6f3c;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.9;
        }

        .link {
            text-align: center;
            margin-top: 10px;
            color: #007bff;
            cursor: pointer;
        }

        #avatarPreview {
            width: 95px;
            height: 95px;
            border-radius: 50%;
            display: block;
            margin: 10px auto;
            object-fit: cover;
            border: 2px solid #ff6f3c;
        }
    </style>
</head>

<body>

    <!-- صفحة تسجيل الدخول -->
    <div class="page" id="loginPage">
        <h2>تسجيل الدخول</h2>

        <input id="loginEmail" type="email" placeholder="البريد الإلكتروني">
        <input id="loginPassword" type="password" placeholder="كلمة المرور">

        <button onclick="login()">دخول</button>

        <div class="link" onclick="showPage('signupPage')">إنشاء حساب جديد</div>
    </div>

    <!-- صفحة إنشاء حساب -->
    <div class="page" id="signupPage">
        <h2>إنشاء حساب جديد</h2>

        <img id="avatarPreview" src="">

        <input type="file" id="avatarInput">
        <input id="signupName" type="text" placeholder="اسم المستخدم">
        <input id="signupEmail" type="email" placeholder="البريد الإلكتروني">
        <input id="signupPassword" type="password" placeholder="كلمة المرور">

        <button onclick="signup()">إنشاء الحساب</button>

        <div class="link" onclick="showPage('loginPage')">لديك حساب؟ تسجيل الدخول</div>
    </div>

    <!-- صفحة الـ OTP -->
    <div class="page" id="otpPage">
        <h2>أدخل رمز التحقق</h2>

        <input id="otpInput" type="text" placeholder="رمز التحقق من البريد">

        <button onclick="verifyOTP()">تأكيد</button>
    </div>

    <!-- الصفحة الرئيسية -->
    <div class="page" id="homePage">
        <h2>أهلاً بك</h2>

        <img id="homeAvatar" style="width:100px;height:100px;border-radius:50%;display:block;margin:auto;">

        <h3 id="homeName" style="text-align:center;"></h3>

        <button onclick="logout()">تسجيل الخروج</button>
    </div>

    <script>
        const supabase = supabase.createClient(
            "https://nzdvboeacarlcgoeixu.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZHZib2Vhb2NhcmxjZ29laXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTI3NTAsImV4cCI6MjA4MDMyODc1MH0.mA-hf6902t2xLH_kUedHmy0sQrjGIAmoCqN2rHZ6K_E"
        );

        function showPage(id) {
            document.querySelectorAll(".page").forEach(p => p.style.display = "none");
            document.getElementById(id).style.display = "block";
        }

        showPage("loginPage");

        // معاينة الصورة
        document.getElementById("avatarInput").onchange = e => {
            let file = e.target.files[0];
            document.getElementById("avatarPreview").src = URL.createObjectURL(file);
        };

        // إنشاء حساب
        async function signup() {
            let name = signupName.value;
            let email = signupEmail.value;
            let pass = signupPassword.value;
            let avatarFile = avatarInput.files[0];

            if (!email || !pass || !name) {
                alert("املأ كل البيانات");
                return;
            }

            let { data, error } = await supabase.auth.signUp({
                email: email,
                password: pass
            });

            if (error) return alert(error.message);

            window.localStorage.setItem("pending_uid", data.user.id);
            window.localStorage.setItem("pending_name", name);

            if (avatarFile) {
                window.localStorage.setItem("pending_avatar", avatarFile.name);
            }

            showPage("otpPage");
        }

        // تأكيد OTP
        async function verifyOTP() {
            let email = signupEmail.value;
            let token = otpInput.value;

            let { data, error } = await supabase.auth.verifyOtp({
                email: email,
                token,
                type: "signup"
            });

            if (error) return alert(error.message);

            let uid = window.localStorage.getItem("pending_uid");
            let name = window.localStorage.getItem("pending_name");

            await supabase.from("profiles").insert({
                id: uid,
                name: name,
                image: document.getElementById("avatarPreview").src
            });

            loadProfile();
        }

        // دخول
        async function login() {
            let email = loginEmail.value;
            let pass = loginPassword.value;

            let { data, error } = await supabase.auth.signInWithPassword({
                email,
                password: pass
            });

            if (error) return alert(error.message);

            loadProfile();
        }

        // تحميل البروفايل بعد الدخول
        async function loadProfile() {
            let { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            let { data } = await supabase.from("profiles").select("*").eq("id", user.id).single();

            homeName.innerText = data.name;
            homeAvatar.src = data.image;

            showPage("homePage");
        }

        // خروج
        async function logout() {
            await supabase.auth.signOut();
            showPage("loginPage");
        }
    </script>

</body>
</html>